System.register(["jimu-core","jimu-arcgis"],(function(e,t){var n={},i={};return{setters:[function(e){n.DataSourceComponent=e.DataSourceComponent,n.FormattedMessage=e.FormattedMessage,n.React=e.React,n.jsx=e.jsx,n.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules},function(e){i.JimuMapViewComponent=e.JimuMapViewComponent}],execute:function(){e((()=>{var e={56:(e,t,n)=>{"use strict";e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},72:e=>{"use strict";var t=[];function n(e){for(var n=-1,i=0;i<t.length;i++)if(t[i].identifier===e){n=i;break}return n}function i(e,i){for(var r={},l=[],a=0;a<e.length;a++){var s=e[a],u=i.base?s[0]+i.base:s[0],c=r[u]||0,d="".concat(u," ").concat(c);r[u]=c+1;var p=n(d),f={css:s[1],media:s[2],sourceMap:s[3],supports:s[4],layer:s[5]};if(-1!==p)t[p].references++,t[p].updater(f);else{var v=o(f,i);i.byIndex=a,t.splice(a,0,{identifier:d,updater:v,references:1})}l.push(d)}return l}function o(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,o){var r=i(e=e||[],o=o||{});return function(e){e=e||[];for(var l=0;l<r.length;l++){var a=n(r[l]);t[a].references--}for(var s=i(e,o),u=0;u<r.length;u++){var c=n(r[u]);0===t[c].references&&(t[c].updater(),t.splice(c,1))}r=s}}},113:e=>{"use strict";e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},244:e=>{"use strict";e.exports=n},314:e=>{"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",i=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),i&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),i&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,i,o,r){"string"==typeof e&&(e=[[null,e,void 0]]);var l={};if(i)for(var a=0;a<this.length;a++){var s=this[a][0];null!=s&&(l[s]=!0)}for(var u=0;u<e.length;u++){var c=[].concat(e[u]);i&&l[c[0]]||(void 0!==r&&(void 0===c[5]||(c[1]="@layer".concat(c[5].length>0?" ".concat(c[5]):""," {").concat(c[1],"}")),c[5]=r),n&&(c[2]?(c[1]="@media ".concat(c[2]," {").concat(c[1],"}"),c[2]=n):c[2]=n),o&&(c[4]?(c[1]="@supports (".concat(c[4],") {").concat(c[1],"}"),c[4]=o):c[4]="".concat(o)),t.push(c))}},t}},400:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(601),o=n.n(i),r=n(314),l=n.n(r)()(o());l.push([e.id,'.parking-lot-widget{padding:16px;font-family:"Avenir Next","Helvetica Neue",Arial,sans-serif}.parking-lot-widget,.parking-lot-widget *{pointer-events:none !important;user-select:none !important}.widget-header{margin-bottom:16px}.widget-header h3{margin:0;font-size:18px;font-weight:600;color:#323232}.widget-content{min-height:100px}.parking-lot-list{display:flex;flex-direction:column;gap:12px}.parking-lot-item{background:white;border-radius:8px;padding:10px 12px;box-shadow:0 2px 8px rgba(0, 0, 0, 0.1);border:1px solid #e0e0e0}.parking-lot-content{display:flex;align-items:center;gap:12px;margin-bottom:2px}.utilization-dot{width:20px;height:20px;border-radius:50%;flex-shrink:0;border:2px solid white;box-shadow:0 1px 3px rgba(0, 0, 0, 0.2)}.parking-lot-name{font-size:16px;font-weight:700;color:#323232;line-height:1.3;display:flex;align-items:center}.utilization-text{font-size:14px;color:#666;font-weight:400;margin-left:32px}.no-data{text-align:center;color:#999;font-style:italic;padding:20px;background:#f8f8f8;border-radius:8px;border:1px dashed #ccc}.loading{text-align:center;color:#666;padding:20px;background:#f8f8f8;border-radius:8px;border:1px solid #e0e0e0}@media(max-width: 480px){.parking-lot-widget{padding:12px}.parking-lot-item{padding:10px}.parking-lot-name{font-size:14px}.utilization-text{font-size:12px}}.parking-lot-item:hover{box-shadow:0 4px 12px rgba(0, 0, 0, 0.15);transform:translateY(-1px);transition:all .2s ease}.parking-lot-widget.loading{opacity:.6;pointer-events:none}.parking-lot-widget.loading::after{content:"";position:absolute;top:50%;left:50%;width:20px;height:20px;margin:-10px 0 0 -10px;border:2px solid #f3f3f3;border-top:2px solid #3498db;border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}',""]);const a=l},540:e=>{"use strict";e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},601:e=>{"use strict";e.exports=function(e){return e[1]}},659:e=>{"use strict";var t={};e.exports=function(e,n){var i=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!i)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");i.appendChild(n)}},686:e=>{"use strict";e.exports=i},825:e=>{"use strict";e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var i="";n.supports&&(i+="@supports (".concat(n.supports,") {")),n.media&&(i+="@media ".concat(n.media," {"));var o=void 0!==n.layer;o&&(i+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),i+=n.css,o&&(i+="}"),n.media&&(i+="}"),n.supports&&(i+="}");var r=n.sourceMap;r&&"undefined"!=typeof btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(r))))," */")),t.styleTagTransform(i,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}}},t={};function o(n){var i=t[n];if(void 0!==i)return i.exports;var r=t[n]={id:n,exports:{}};return e[n](r,r.exports,o),r.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.p="",o.nc=void 0;var r={};return o.p=window.jimuConfig.baseUrl,(()=>{"use strict";o.r(r),o.d(r,{__set_webpack_public_path__:()=>E,default:()=>N});var e=o(244),t=o(686),n=o(72),i=o.n(n),l=o(825),a=o.n(l),s=o(659),u=o.n(s),c=o(56),d=o.n(c),p=o(540),f=o.n(p),v=o(113),h=o.n(v),m=o(400),g={};g.styleTagTransform=h(),g.setAttributes=d(),g.insert=u().bind(null,"head"),g.domAPI=a(),g.insertStyleElement=f();i()(m.A,g);m.A&&m.A.locals&&m.A.locals;const y="Please configure a data source in the widget settings";var b=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function l(e){try{s(i.next(e))}catch(e){r(e)}}function a(e){try{s(i.throw(e))}catch(e){r(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,a)}s((i=i.apply(e,t||[])).next())}))};const x=(e,t)=>{"undefined"!=typeof console&&console.log&&console.log("[parking-lot-widget]",e,null!=t?t:"")},w="http://www.w3.org/2000/svg",A=50,C=46,S=(e,t,n,i)=>{const o=Math.PI/180*i;return{x:e+n*Math.cos(o),y:t+n*Math.sin(o)}},k=(e,t,n,i,o)=>{const r=i+o,l=S(e,t,n,i),a=S(e,t,n,r),s=Math.abs(o)>180?"1":"0",u=o<0?"0":"1";return["M",l.x.toFixed(2),l.y.toFixed(2),"A",n.toFixed(2),n.toFixed(2),"0",s,u,a.x.toFixed(2),a.y.toFixed(2)].join(" ")},F=(e,t,n,i,o)=>{const r=S(e,t,n,i),l=S(e,t,n,i+o),a=Math.abs(o)>180?"1":"0",s=o<0?"0":"1";return["M",e.toFixed(2),t.toFixed(2),"L",r.x.toFixed(2),r.y.toFixed(2),"A",n.toFixed(2),n.toFixed(2),"0",a,s,l.x.toFixed(2),l.y.toFixed(2),"Z"].join(" ")},N=n=>{const{config:i,id:o,useDataSources:r,useMapWidgetIds:l}=n,a=(null==r?void 0:r[0])||null,s=!!(l&&l.length>0),u=!!a,c=s&&u,[d,p]=e.React.useState(null),[f,v]=e.React.useState([]),[h,m]=e.React.useState(null),[g,S]=e.React.useState(null),[N,E]=e.React.useState(!1),[R,M]=e.React.useState(!0),z=e.React.useRef(null),I=e.React.useRef(null),T=e.React.useRef([]),D=e.React.useRef(null),L=e.React.useRef(null),j=e.React.useRef(!1),U=e.React.useRef(!1),P=e.React.useRef(null),O=e.React.useRef(null),q=e.React.useRef(null),B=e.React.useRef(null),G=e.React.useRef(null),$=(null==a?void 0:a.dataSourceId)||null,J=null!==$&&O.current===$,V=u&&R&&!J,_=e.React.useMemo((()=>({returnGeometry:!0,outFields:["*"]})),[]),H=e.React.useRef(!1),K=e.React.useCallback((e=>{var t;const n=null==l?void 0:l[0],i=null===(t=null==e?void 0:e.view)||void 0===t?void 0:t.container,o=null==i?void 0:i.parentElement,r=n?document.querySelector(`[data-widget-id="${n}"] .map-root`):null,a=n?document.querySelector(`[data-widget-id="${n}"] .esri-view-root`):null,s=n?document.querySelector(`[data-widget-id="${n}"] .esri-view`):null,u=n?document.querySelector(`[data-widget-id="${n}"]`):null;return i||o||a||s||r||u||null}),[l]),W=e.React.useCallback((e=>{if(!e)return;e.querySelectorAll(".parking-lot-map-label").forEach((e=>{e.parentNode&&e.parentNode.removeChild(e)}))}),[]),Z=e.React.useCallback((()=>{var e;W(h);const t=null===(e=null==d?void 0:d.view)||void 0===e?void 0:e.container;t&&t!==h&&W(t)}),[h,d,W]),Y=e.React.useCallback((e=>{var t,n,i;if(!e)return null;if(null===(t=null==e?void 0:e.feature)||void 0===t?void 0:t.geometry)return e.feature;if((null===(n=null==e?void 0:e.feature)||void 0===n?void 0:n.attributes)&&"function"==typeof(null==e?void 0:e.getJSAPIGeometry)){const t=e.getJSAPIGeometry();if(t)return{geometry:t,attributes:e.feature.attributes}}if("function"==typeof(null==e?void 0:e.getJSAPIGeometry)){const t=e.getJSAPIGeometry(),n=(null===(i=e.getData)||void 0===i?void 0:i.call(e))||{};if(t)return{geometry:t,attributes:n}}return(null==e?void 0:e.attributes)&&(null==e?void 0:e.geometry)?e:null}),[]),Q=e.React.useCallback((e=>{var t;if(!e)return null;const n="function"==typeof(null==e?void 0:e.getData)&&e.getData()||null,i=(null===(t=null==e?void 0:e.feature)||void 0===t?void 0:t.attributes)||null,o=(null==e?void 0:e.attributes)||null,r={},l=e=>{e&&"object"==typeof e&&Object.keys(e).forEach((t=>{const n=e[t];null!=n?r[t]=n:t in r||(r[t]=n)}))};return l(i),l(o),l(n),Object.keys(r).length>0?r:null}),[]),X=e.React.useCallback(((e,t)=>{if(!e||!t)return{value:void 0,resolvedKey:null};if(Object.prototype.hasOwnProperty.call(e,t))return{value:e[t],resolvedKey:t};const n=t.toLowerCase(),i=Object.keys(e),o=i.find((e=>e.toLowerCase().startsWith(n)));if(o)return{value:e[o],resolvedKey:o};const r=i.find((e=>n.startsWith(e.toLowerCase())));if(r)return{value:e[r],resolvedKey:r};const l=i.find((e=>e.toLowerCase().includes(n)));return l?{value:e[l],resolvedKey:l}:{value:void 0,resolvedKey:null}}),[]),ee=e.React.useCallback((e=>{if("number"==typeof e)return Number.isFinite(e)?e:NaN;if("string"==typeof e){const t=e.trim().replace("%",""),n=Number(t);if(Number.isFinite(n))return n;const i=Number.parseFloat(t);return Number.isFinite(i)?i:NaN}const t=Number(e);return Number.isFinite(t)?t:NaN}),[]),te=e.React.useCallback((e=>{const t=X(e,i.utilizationField);if(Number.isFinite(ee(t.value)))return t;if(!e)return t;const n=Object.keys(e).filter((e=>{const t=e.toLowerCase();return t.includes("util")||t.includes("occup")||t.includes("usage")}));for(const t of n){const n=e[t];if(Number.isFinite(ee(n)))return{value:n,resolvedKey:t}}return t}),[X,ee,i.utilizationField]),ne=e.React.useCallback((e=>{var t;if(e){p(e);const n=K(e),i=null===(t=null==e?void 0:e.view)||void 0===t?void 0:t.container;x("onActiveViewChange",{resolved:!!n,tagName:null==n?void 0:n.tagName,isViewContainer:n===i,hasView:!!(null==e?void 0:e.view)}),n?(n.tagName,n.className,m(n)):x("onActiveViewChange no container")}}),[K]);e.React.useEffect((()=>{if(h||!(null==d?void 0:d.view))return;const e=K(d);e&&(e.tagName,e.className,m(e))}),[d,h,K]),e.React.useEffect((()=>{var e;const t=null===(e=null==d?void 0:d.view)||void 0===e?void 0:e.container;t&&t!==h&&("undefined"==typeof document||document.contains(t))&&(x("sync to view.container",{inDoc:document.contains(t),w:t.offsetWidth,h:t.offsetHeight}),m(t))}),[d,h]),e.React.useEffect((()=>{if(!h)return;"static"===window.getComputedStyle(h).position&&(h.style.position="relative"),h.style.userSelect="none",h.style.webkitUserSelect="none",h.style.msUserSelect="none"}),[h]),e.React.useEffect((()=>{var e,t,n,i,o,r,l,a,s,u,c,d;if(!h)return;const p=h.closest(".map-base"),f=h.querySelector(".esri-view-surface"),v=h.querySelector("canvas"),m=null!==(e=null==p?void 0:p.style.pointerEvents)&&void 0!==e?e:"",g=null!==(t=null==p?void 0:p.style.position)&&void 0!==t?t:"",y=null!==(n=null==p?void 0:p.style.zIndex)&&void 0!==n?n:"",b=null!==(i=h.style.position)&&void 0!==i?i:"",x=null!==(o=h.style.zIndex)&&void 0!==o?o:"",w=null!==(r=h.style.pointerEvents)&&void 0!==r?r:"",A=null!==(l=null==f?void 0:f.style.pointerEvents)&&void 0!==l?l:"",C=null!==(a=null==f?void 0:f.style.position)&&void 0!==a?a:"",S=null!==(s=null==f?void 0:f.style.zIndex)&&void 0!==s?s:"",k=null!==(u=null==v?void 0:v.style.pointerEvents)&&void 0!==u?u:"",F=null!==(c=null==v?void 0:v.style.position)&&void 0!==c?c:"",N=null!==(d=null==v?void 0:v.style.zIndex)&&void 0!==d?d:"";return p&&(p.style.pointerEvents="auto","static"===window.getComputedStyle(p).position&&(p.style.position="relative"),p.style.zIndex="0"),"static"===window.getComputedStyle(h).position&&(h.style.position="relative"),h.style.pointerEvents="auto",h.style.zIndex="2",f&&(f.style.pointerEvents="auto",f.style.position="relative",f.style.zIndex="3"),v&&(v.style.pointerEvents="auto",v.style.position="relative",v.style.zIndex="4"),()=>{p&&(p.style.pointerEvents=m),p&&(p.style.position=g),p&&(p.style.zIndex=y),h.style.position=b,h.style.zIndex=x,h.style.pointerEvents=w,f&&(f.style.pointerEvents=A),f&&(f.style.position=C),f&&(f.style.zIndex=S),v&&(v.style.pointerEvents=k),v&&(v.style.position=F),v&&(v.style.zIndex=N)}}),[h]),e.React.useLayoutEffect((()=>{if(z.current)return()=>{}}),[o]),e.React.useEffect((()=>{var e;const t=null===(e=null==d?void 0:d.view)||void 0===e?void 0:e.container;if(!t)return;const n=document.querySelector(`[data-widgetid="${o}"]`),i=t.closest(".map-base"),r=[],l=e=>{e&&(r.push({el:e,prev:e.style.pointerEvents||""}),e.style.pointerEvents="auto")};return l(n),l(i),l(t),()=>{r.forEach((({el:e,prev:t})=>{e.style.pointerEvents=t}))}}),[o,d]),e.React.useEffect((()=>{if(d&&f.length>0){const e=()=>{const e=d.view.zoom,t=Math.max(.3,Math.min(1,(e-10)/8));f.forEach((e=>{try{const n=d.view.toScreen(e.geometry);if(e.element){e.element.style.transform=`scale(${t}) translateZ(0)`,e.element.style.transformOrigin="20px bottom";const i=e.element.offsetHeight||60;e.element.style.left=n.x-20+"px",e.element.style.top=n.y-i-8+"px"}}catch(e){}}))},t=()=>{null===D.current&&(D.current=window.requestAnimationFrame((()=>{D.current=null,e()})))},n=[d.view.watch("extent",t),d.view.watch("center",t),d.view.watch("zoom",t)],i=d.view;"function"==typeof(null==i?void 0:i.watch)&&(null!=i.width&&n.push(i.watch("width",t)),null!=i.height&&n.push(i.watch("height",t)));const o=(null==i?void 0:i.container)||h;let r=null;"undefined"!=typeof ResizeObserver&&o&&(r=new ResizeObserver((()=>t())),r.observe(o)),t();let l=window.requestAnimationFrame((()=>{e(),l=null}));const a="undefined"!=typeof window&&/Mobi|Android|iPhone|iPad/i.test(window.navigator.userAgent),s="undefined"!=typeof window&&window.self!==window.top,u=a||s?window.setTimeout((()=>t()),400):null;return()=>{null!=u&&window.clearTimeout(u),null==r||r.disconnect(),null!=l&&window.cancelAnimationFrame(l),null!==D.current&&(window.cancelAnimationFrame(D.current),D.current=null),n.forEach((e=>{e&&"function"==typeof e.remove&&e.remove()}))}}}),[d,f,h]),e.React.useEffect((()=>()=>{f.forEach((e=>{e.element&&e.element.parentNode&&e.element.parentNode.removeChild(e.element)}))}),[f]),e.React.useEffect((()=>{if(!H.current)return void(H.current=!0);Z(),v([]),E(!0),M(!0),I.current=null,L.current=null,j.current=!1,U.current=!1,P.current=null,O.current=null,q.current=null,B.current=null}),[Z,i.parkingLotField,i.utilizationField,i.showUtilizationText,i.allowNegatives,i.fullThreshold,i.availableColor,i.unavailableColor]),e.React.useEffect((()=>{if(!r||0===r.length)return S(null),E(!1),M(!1),P.current=null,O.current=null,q.current=null,void(B.current=null);const e=$;null===g&&!!e&&O.current!==e&&B.current!==e&&(B.current=e,M(!0),E(!0),P.current=null,I.current=null,q.current=null),null!==g&&e!==g&&(I.current=null,Z(),v([]),L.current=null,j.current=!1,U.current=!1,P.current=null,O.current=null,B.current=null,E(!0),M(!0),q.current=null),g!==e&&S(e)}),[$,g,Z,h]);const ie=e.React.useCallback((e=>{null==e||e.reason;return E(!0),!0}),[]),oe=e.React.useCallback((e=>{var t;if(!h)return;const n=h.querySelectorAll(".parking-lot-map-label");if(0===n.length)return;const o=new Map;n.forEach((e=>{const t=e.getAttribute("data-parking-lot-id");t&&o.set(t,e)}));for(const n of e){const e=Q(n);if(!e)continue;const{value:r}=X(e,i.parkingLotField),{value:l}=te(e);if(!r)continue;const a=String(r),s=o.get(a);if(!s)continue;const u=ee(l);if(!Number.isFinite(u)){s.parentNode&&s.parentNode.removeChild(s);continue}const c=Number.isFinite(u)?u:0,d=i.availableColor||"#d638c9",p=i.unavailableColor||"#8B8B8B",f=Math.max(0,Math.min(100,null!==(t=i.fullThreshold)&&void 0!==t?t:95));let v=100-c;!i.allowNegatives&&v<0&&(v=0);const h=c>=f||v<=Math.max(0,100-f)?"Full":`${Math.round(Math.max(0,Math.min(100,v)))}% Available`,m=i.showUtilizationText?h:"";let g=100-c;!i.allowNegatives&&g<0&&(g=0);const y=Math.max(0,Math.min(100,g));s.setAttribute("aria-label",`${r}: ${h}`);const b=Array.from(s.children),x=b[0],S=b[1];if(x){const e=x.querySelector("svg");if(e){const t=Math.max(0,Math.min(100,y)),n=-Math.min(t/100*360,359.999),i=Array.from(e.children),o=i[0];o&&"circle"===o.tagName&&o.setAttribute("fill",p);for(let t=i.length-2;t>=1;t--)e.removeChild(i[t]);if(t>0)if(t>=99.5){const t=document.createElementNS(w,"circle");t.setAttribute("cx",A.toFixed(2)),t.setAttribute("cy",A.toFixed(2)),t.setAttribute("r",(C-3).toFixed(2)),t.setAttribute("fill",d),t.setAttribute("stroke","none"),e.insertBefore(t,e.lastChild)}else{const t=document.createElementNS(w,"path");t.setAttribute("d",F(A,A,C-3,-90,n)),t.setAttribute("fill",d),t.setAttribute("stroke","none"),e.insertBefore(t,e.lastChild);const i=document.createElementNS(w,"path");i.setAttribute("d",k(A,A,C-3,-90,n)),i.setAttribute("fill","none"),i.setAttribute("stroke",d),i.setAttribute("stroke-width","3.5"),e.insertBefore(i,e.lastChild)}}}if(S){const e=Array.from(S.children);let t=i.showUtilizationText?0:-1,n=i.showUtilizationText?1:0;if(i.showUtilizationText&&t>=0&&e[t]){const n=e[t];n.textContent!==m&&(n.textContent=m)}if(e[n]){const t=e[n];t.textContent!==r&&(t.textContent=r)}}}}),[h,Q,X,ee,i.parkingLotField,i.utilizationField,i.availableColor,i.unavailableColor,i.allowNegatives,i.showUtilizationText,i.fullThreshold]);e.React.useEffect((()=>{var e,t;if(!N)return void x("refresh skipped",{reason:"shouldUpdateLabels false"});if(!(null===(e=null==d?void 0:d.view)||void 0===e?void 0:e.ready))return x("refresh skipped",{reason:"view not ready"}),void E(!1);if(!g)return x("refresh skipped",{reason:"no currentDataSourceId"}),void E(!1);if(!h)return x("refresh skipped",{reason:"no mapContainer"}),void E(!1);const n=I.current,o=$;if(!n||!o||g!==o)return x("refresh skipped",{reason:"ds mismatch",hasDs:!!n,currentDataSourceId:g,dsId:o}),void E(!1);const r=null===(t=n.getStatus)||void 0===t?void 0:t.call(n);if("LOADED"!==r)return x("refresh skipped",{reason:"ds not LOADED",dsStatus:r}),void E(!1);if(j.current||U.current)return void x("refresh skipped",{reason:"already in flight"});x("refresh running",{dsId:o,hasMapContainer:!!h}),P.current=o;let l=!1;return j.current=!0,U.current=!0,b(void 0,void 0,void 0,(function*(){var e,t,r;try{let a=0,s=0;const u=()=>b(void 0,void 0,void 0,(function*(){var e,t;const r=(null===(e=null==n?void 0:n.getRecords)||void 0===e?void 0:e.call(n))||[],l=r.slice(0,1e3);if(a=l.length,G.current!==o){const e=l.slice(0,5).map(((e,t)=>{const n=Q(e),o=te(n),r=o.value,l=ee(r);return{index:t,parkingLot:X(n,i.parkingLotField).value,rawUtilization:r,resolvedUtilizationField:o.resolvedKey,rawType:typeof r,parsedUtilization:l,parsedIsFinite:Number.isFinite(l)}})),t=l.reduce(((e,t)=>{const n=Q(t),i=te(n);return Number.isFinite(ee(i.value))?e+1:e}),0);s=t,console.log("[parking-lot-widget][diag] utilization field probe",{dsId:o,parkingLotField:i.parkingLotField,utilizationField:i.utilizationField,recordsCount:l.length,finiteUtilizationCount:t,nonFiniteUtilizationCount:Math.max(0,l.length-t),sample:e}),G.current=o}else s=l.reduce(((e,t)=>{const n=Q(t),o=X(n,i.utilizationField);return Number.isFinite(ee(o.value))?e+1:e}),0);const u=l.map((e=>Y(e))).filter((e=>e)),c=u.filter((e=>null==e?void 0:e.geometry));if(r.length,u.length,c.length,i.parkingLotField,i.utilizationField,r.length>0){const e=r[0],n="function"==typeof(null==e?void 0:e.getData)?e.getData():(null==e?void 0:e.attributes)||(null===(t=null==e?void 0:e.feature)||void 0===t?void 0:t.attributes);null==e||e.getData,null==e||e.getJSAPIGeometry,n&&Object.keys(n),i.parkingLotField,null==n||n[i.parkingLotField],i.utilizationField,null==n||n[i.utilizationField]}return r.length,l.length,c.length,c})),c=yield u();if(x("loadFeatures done",{dsId:o,featuresCount:c.length,boundedRecordsCount:a,finiteUtilizationCount:s}),l)return;if(a>0&&0===s)return x("refresh bail",{reason:"zero finite utilization",recordsCount:a}),Z(),v([]),E(!1),M(!1),void(O.current=o);if(0===c.length){const t=((null===(e=null==n?void 0:n.getRecords)||void 0===e?void 0:e.call(n))||[]).slice(0,1e3),i=t.length>0,r=h.querySelectorAll(".parking-lot-map-label").length;return x("refresh zero features",{dsId:o,recordCount:t.length,hasAnyRecords:i,labelsInDOM:r}),t.length,i&&(oe(t),t.length),E(!1),i?(M(!1),void(O.current=o)):void(P.current=null)}const p=h.querySelectorAll(".parking-lot-map-label").length,f=0===p;if(c.length,f){x("createCustomLabels start",{featuresCount:c.length,viewW:null===(t=null==d?void 0:d.view)||void 0===t?void 0:t.width,viewH:null===(r=null==d?void 0:d.view)||void 0===r?void 0:r.height}),yield se(c);const e=h.querySelectorAll(".parking-lot-map-label").length;x("createCustomLabels done",{createdLabels:e,containerTag:null==h?void 0:h.tagName,inDoc:document.contains(h)}),e>0&&(L.current=o)}else c.length,yield ue(c);E(!1),M(!1),O.current=o,h.querySelectorAll(".parking-lot-map-label").length}catch(e){String(e),E(!1)}finally{j.current=!1,U.current=!1}})),()=>{l=!0}}),[N,d,g,$,h,i.parkingLotField,i.utilizationField,i.showUtilizationText,i.allowNegatives,i.fullThreshold,i.availableColor,i.unavailableColor,Y,oe,X,ee]);const re=e.React.useCallback(((e,t)=>{if(null==e||e.status,null==t||t.status,null==e||e.sourceVersion,null==t||t.sourceVersion,null==e||e.needRefresh,null==t||t.needRefresh,null==e||e.sourceVersion,null==e||e.status,null==t||t.status,null==t||t.sourceVersion,P.current,!e)return;const n=$;if(!n)return;if("LOAD_ERROR"===e.status)return E(!1),M(!1),void(O.current=n);"LOADED"===e.status&&P.current!==n&&O.current!==n&&ie({reason:"data-source-initial-loaded"})}),[$,ie]),le=e=>{var t;const n=Math.max(0,Math.min(100,null!==(t=i.fullThreshold)&&void 0!==t?t:95));let o=100-e;if(!i.allowNegatives&&o<0&&(o=0),e>=n||o<=Math.max(0,100-n))return"Full";const r=Math.max(0,Math.min(100,o));return`${Math.round(r)}% Available`},ae=(e,t,n)=>{const i=Math.max(0,Math.min(100,e)),o=-Math.min(i/100*360,359.999),r=document.createElement("div");r.style.cssText="\n      width: 44px;\n      height: 44px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      flex-shrink: 0;\n      pointer-events: none;\n    ",r.setAttribute("aria-hidden","true");const l=document.createElementNS(w,"svg");l.setAttribute("width","44"),l.setAttribute("height","44"),l.setAttribute("viewBox","0 0 100 100"),l.style.display="block",l.style.flexShrink="0",l.style.pointerEvents="none",l.setAttribute("role","presentation"),l.setAttribute("focusable","false");const a=document.createElementNS(w,"circle");if(a.setAttribute("cx",A.toFixed(2)),a.setAttribute("cy",A.toFixed(2)),a.setAttribute("r",C.toFixed(2)),a.setAttribute("fill",n),a.setAttribute("stroke","none"),l.appendChild(a),i>0)if(i>=99.5){const e=document.createElementNS(w,"circle");e.setAttribute("cx",A.toFixed(2)),e.setAttribute("cy",A.toFixed(2)),e.setAttribute("r",(C-3).toFixed(2)),e.setAttribute("fill",t),e.setAttribute("stroke","none"),l.appendChild(e)}else{const e=document.createElementNS(w,"path");e.setAttribute("d",F(A,A,C-3,-90,o)),e.setAttribute("fill",t),e.setAttribute("stroke","none"),l.appendChild(e);const n=document.createElementNS(w,"path");n.setAttribute("d",k(A,A,C-3,-90,o)),n.setAttribute("fill","none"),n.setAttribute("stroke",t),n.setAttribute("stroke-width","3.5"),l.appendChild(n)}const s=document.createElementNS(w,"circle");return s.setAttribute("cx",A.toFixed(2)),s.setAttribute("cy",A.toFixed(2)),s.setAttribute("r",(C-1.5).toFixed(2)),s.setAttribute("fill","none"),s.setAttribute("stroke","#333333"),s.setAttribute("stroke-width","3"),l.appendChild(s),r.appendChild(l),r},se=t=>b(void 0,void 0,void 0,(function*(){var n;const o=(null===(n=null==d?void 0:d.view)||void 0===n?void 0:n.container)||h;if(x("createCustomLabels entry",{recordCount:null==t?void 0:t.length,hasMapContainer:!!h,hasAppendTarget:!!o,appendInDoc:!!o&&document.contains(o),appendW:null==o?void 0:o.offsetWidth,appendH:null==o?void 0:o.offsetHeight}),!h||!d)return void x("createCustomLabels exit",{reason:"missing mapContainer or jimuMapView"});let r=null;try{r=(yield(0,e.loadArcGISJSAPIModules)(["esri/geometry/projection","esri/geometry/Point","esri/geometry/SpatialReference"]))[0],yield r.load()}catch(e){}const l=new Set,a=[],s=new Map;h.querySelectorAll(".parking-lot-map-label").forEach((e=>{const t=e.getAttribute("data-parking-lot-id");t&&s.set(t,e)}));let u=0;const c={};for(const e of t){let t,n=null;if("function"==typeof e.getData){t=e.getData();try{if("function"==typeof e.getJSAPIGeometry)n=e.getJSAPIGeometry();else if("function"==typeof e.getGeometry){const t=e.getGeometry();t&&(n=t)}}catch(e){}}else e.attributes&&e.geometry?(t=e.attributes,n=e.geometry):(t=e.data||e.attributes||e,n=e.geometry||e.geom||null);const{value:o}=X(t,i.parkingLotField),{value:p}=te(t);if(!n){u++,c.noGeometry=(c.noGeometry||0)+1;continue}if(!o){u++,c.noName=(c.noName||0)+1;continue}const f=ee(p);if(!Number.isFinite(f)){u++,c.noUtilization=(c.noUtilization||0)+1;continue}const v=Number.isFinite(f)?f:0,m=i.availableColor||"#d638c9",g=i.unavailableColor||"#8B8B8B",y=le(v),b=i.showUtilizationText?y:"";let x=100-v;!i.allowNegatives&&x<0&&(x=0);const S=Math.max(0,Math.min(100,x)),N=String(o);l.add(N);try{const e=d.view.spatialReference,t=n.spatialReference;if(r&&t&&e&&t.wkid!==e.wkid){const t=r.project(n,e);t&&(n=t)}}catch(e){}let E;try{E=d.view.toScreen(n)}catch(e){u++,c.coordError=(c.coordError||0)+1;continue}let R=s.get(N);const M=!R;if(R){const e=E.x-50+"px",r=E.y-30+"px";R.style.left!==e&&(R.style.left=e),R.style.top!==r&&(R.style.top=r),R.setAttribute("aria-label",`${o}: ${y}`);const l=Array.from(R.children),s=l[0],u=l[1];if(s){const e=s.querySelector("svg");if(e){const t=Math.max(0,Math.min(100,S)),n=-Math.min(t/100*360,359.999),i=Array.from(e.children),o=i[0];o&&"circle"===o.tagName&&o.setAttribute("fill",g);for(let t=i.length-2;t>=1;t--)e.removeChild(i[t]);if(t>0)if(t>=99.5){const t=document.createElementNS(w,"circle");t.setAttribute("cx",A.toFixed(2)),t.setAttribute("cy",A.toFixed(2)),t.setAttribute("r",(C-3).toFixed(2)),t.setAttribute("fill",m),t.setAttribute("stroke","none"),e.insertBefore(t,e.lastChild)}else{const t=document.createElementNS(w,"path");t.setAttribute("d",F(A,A,C-3,-90,n)),t.setAttribute("fill",m),t.setAttribute("stroke","none"),e.insertBefore(t,e.lastChild);const i=document.createElementNS(w,"path");i.setAttribute("d",k(A,A,C-3,-90,n)),i.setAttribute("fill","none"),i.setAttribute("stroke",m),i.setAttribute("stroke-width","3.5"),e.insertBefore(i,e.lastChild)}}}if(u){const e=Array.from(u.children);let t=i.showUtilizationText?0:-1,n=i.showUtilizationText?1:0;if(i.showUtilizationText&&t>=0&&e[t]){const n=e[t];n.textContent!==b&&(n.textContent=b)}if(e[n]){const t=e[n];t.textContent!==o&&(t.textContent=o)}}a.push({element:R,geometry:n,data:t});continue}R=document.createElement("div"),R.className="parking-lot-map-label",R.setAttribute("role","img"),R.setAttribute("aria-label",`${o}: ${y}`),R.setAttribute("tabindex","-1"),R.setAttribute("data-parking-lot-id",N),R.style.cssText=`\n        position: absolute;\n        left: ${E.x-50}px;\n        top: ${E.y-30}px;\n        background: white;\n        border-radius: 12px;\n        padding: 8px 8px;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n        border: 1px solid #d0d0d0;\n        font-family: 'Avenir Next', 'Helvetica Neue', Arial, sans-serif;\n        z-index: 1000;\n        pointer-events: none;\n        user-select: none;\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        min-width: 150px;\n        transform: translateZ(0);\n        -webkit-transform: translateZ(0);\n      `;const z=document.createElement("div");z.style.cssText="\n        position: absolute;\n        bottom: -8px;\n        left: 20px;\n        width: 0;\n        height: 0;\n        border-left: 8px solid transparent;\n        border-right: 8px solid transparent;\n        border-top: 8px solid white;\n        z-index: 1001;\n      ";const I=document.createElement("div");I.style.cssText="\n        position: absolute;\n        bottom: -9px;\n        left: 20px;\n        width: 0;\n        height: 0;\n        border-left: 9px solid transparent;\n        border-right: 9px solid transparent;\n        border-top: 9px solid #d0d0d0;\n        z-index: 1000;\n      ";const T=ae(S,m,g),D=document.createElement("div");if(D.style.cssText="\n        display: flex;\n        flex-direction: column;\n        gap: 1px;\n      ",i.showUtilizationText){const e=document.createElement("div");e.textContent=b,e.style.cssText="\n          font-size: 16px;\n          color: #000000;\n          line-height: 1.2;\n          font-weight: 900;\n        ",D.appendChild(e)}const L=document.createElement("div");L.textContent=o,L.style.cssText="\n        font-size: 13px;\n        font-weight: 700;\n        color: #000000;\n        line-height: 1.2;\n      ",D.appendChild(L),R.appendChild(T),R.appendChild(D),R.appendChild(I),R.appendChild(z);R.childNodes.length;if(M)try{h.appendChild(R)}catch(e){continue}else R.childNodes.length,D.textContent;a.push({element:R,geometry:n,data:t})}s.forEach(((e,t)=>{l.has(t)||e.parentNode&&e.parentNode.removeChild(e)}));const p=h.querySelectorAll(".parking-lot-map-label").length;x("createCustomLabels loop done",{newLabelsCount:a.length,finalInDOM:p,skipped:u}),a.length,a.filter((e=>!s.has(e.element.getAttribute("data-parking-lot-id")||""))).length,a.filter((e=>s.has(e.element.getAttribute("data-parking-lot-id")||""))).length,h&&h.tagName,t.length,T.current=a,v(a)})),ue=e=>b(void 0,void 0,void 0,(function*(){if(null==e||e.length,!h||!d)return;const t=h.querySelectorAll(".parking-lot-map-label"),n=new Map,o=new Set;t.forEach((e=>{const t=e.getAttribute("data-parking-lot-id");t&&n.set(t,e)})),n.size,e.length;for(const t of e){let e,r=null;if("function"==typeof t.getData){e=t.getData();try{if("function"==typeof t.getJSAPIGeometry)r=t.getJSAPIGeometry();else if("function"==typeof t.getGeometry){const e=t.getGeometry();e&&(r=e)}}catch(e){continue}}else t.attributes&&t.geometry?(e=t.attributes,r=t.geometry):(e=t.data||t.attributes||t,r=t.geometry||t.geom||null);const{value:l}=X(e,i.parkingLotField),{value:a}=te(e);if(!r||!l)continue;const s=String(l);o.add(s);const u=n.get(s);if(!u)continue;const c=ee(a);if(!Number.isFinite(c)){u.parentNode&&u.parentNode.removeChild(u);continue}const p=Number.isFinite(c)?c:0,f=i.availableColor||"#d638c9",v=i.unavailableColor||"#8B8B8B",h=le(p),m=i.showUtilizationText?h:"";let g=100-p;!i.allowNegatives&&g<0&&(g=0);const y=Math.max(0,Math.min(100,g));try{const e=d.view.toScreen(r),t=e.x-50+"px",n=e.y-30+"px";u.style.left!==t&&(u.style.left=t),u.style.top!==n&&(u.style.top=n)}catch(e){}u.setAttribute("aria-label",`${l}: ${h}`);const b=Array.from(u.children),x=b[0],S=b[1];if(x){const e=x.querySelector("svg");if(e){const t=Math.max(0,Math.min(100,y)),n=Math.min(t/100*360,359.999),i=Array.from(e.children),o=i[0];o&&"circle"===o.tagName&&o.setAttribute("fill",v);for(let t=i.length-2;t>=1;t--)e.removeChild(i[t]);if(t>0)if(t>=99.5){const t=document.createElementNS(w,"circle");t.setAttribute("cx",A.toFixed(2)),t.setAttribute("cy",A.toFixed(2)),t.setAttribute("r",(C-3).toFixed(2)),t.setAttribute("fill",f),t.setAttribute("stroke","none"),e.insertBefore(t,e.lastChild)}else{const t=document.createElementNS(w,"path");t.setAttribute("d",F(A,A,C-3,-90,n)),t.setAttribute("fill",f),t.setAttribute("stroke","none"),e.insertBefore(t,e.lastChild);const i=document.createElementNS(w,"path");i.setAttribute("d",k(A,A,C-3,-90,n)),i.setAttribute("fill","none"),i.setAttribute("stroke",f),i.setAttribute("stroke-width","3.5"),e.insertBefore(i,e.lastChild)}}}if(S){const e=Array.from(S.children);let t=i.showUtilizationText?0:-1,n=i.showUtilizationText?1:0;if(i.showUtilizationText&&t>=0&&e[t]){const n=e[t];n.textContent!==m&&(n.textContent=m)}if(e[n]){const t=e[n];t.textContent!==l&&(t.textContent=l)}}}n.forEach(((e,t)=>{o.has(t)||e.parentNode&&e.parentNode.removeChild(e)})),o.size,n.size,o.size})),ce=(0,e.jsx)(e.React.Fragment,null,s&&(0,e.jsx)(t.JimuMapViewComponent,{useMapWidgetId:l[0],onActiveViewChange:ne}),V?(0,e.jsx)(e.DataSourceComponent,{useDataSource:a,widgetId:o,query:_,onDataSourceInfoChange:re},(e=>{var t,n,i,o,l,a,s,u,c,d,p;const f=null===(t=null==e?void 0:e.getMainDataSource)||void 0===t?void 0:t.call(e),v=null===(n=null==e?void 0:e.getStatus)||void 0===n?void 0:n.call(e),h=null===(i=null==f?void 0:f.getStatus)||void 0===i?void 0:i.call(f),m="UNLOADED"===v&&f&&h&&"UNLOADED"!==h?f:e,g=$;m&&(null==m?void 0:m.getRecords)&&(m.getRecords()||[]).length;return String((null===(o=null==m?void 0:m.getError)||void 0===o?void 0:o.call(m))||(null===(l=null==e?void 0:e.getError)||void 0===l?void 0:l.call(e))||""),null===(a=null==r?void 0:r[0])||void 0===a||a.dataSourceId,e?(I.current=m,x("DataSourceComponent render",{dsId:g,dsStatus:v||(null===(s=null==m?void 0:m.getStatus)||void 0===s?void 0:s.call(m)),recordCount:null!==(d=null===(c=null===(u=null==m?void 0:m.getRecords)||void 0===u?void 0:u.call(m))||void 0===c?void 0:c.length)&&void 0!==d?d:0}),null==m||m.id,null==m||m.type,null===(p=null==m?void 0:m.getStatus)||void 0===p||p.call(m),null):null})):null);return c?ce:(0,e.jsx)("div",{ref:z,className:"parking-lot-widget jimu-widget","data-widget-id":o,style:{width:"100%",height:"100%",overflow:"hidden",position:"relative",pointerEvents:"none",userSelect:"none"}},ce,s?u?null:(0,e.jsx)("div",{className:"no-data"},(0,e.jsx)(e.FormattedMessage,{id:"configureDataSource",defaultMessage:y})):(0,e.jsx)("div",{className:"no-data"},(0,e.jsx)(e.FormattedMessage,{id:"selectMap",defaultMessage:"Please select a map widget in the settings"})))};function E(e){o.p=e}})(),r})())}}}));