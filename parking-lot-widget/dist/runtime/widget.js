System.register(["jimu-core","jimu-arcgis"],(function(e,t){var n={},o={};return{setters:[function(e){n.DataSourceComponent=e.DataSourceComponent,n.FormattedMessage=e.FormattedMessage,n.React=e.React,n.jsx=e.jsx,n.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules},function(e){o.JimuMapViewComponent=e.JimuMapViewComponent}],execute:function(){e((()=>{var e={56:(e,t,n)=>{"use strict";e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},72:e=>{"use strict";var t=[];function n(e){for(var n=-1,o=0;o<t.length;o++)if(t[o].identifier===e){n=o;break}return n}function o(e,o){for(var i={},a=[],l=0;l<e.length;l++){var s=e[l],d=o.base?s[0]+o.base:s[0],c=i[d]||0,u="".concat(d," ").concat(c);i[d]=c+1;var p=n(u),f={css:s[1],media:s[2],sourceMap:s[3],supports:s[4],layer:s[5]};if(-1!==p)t[p].references++,t[p].updater(f);else{var g=r(f,o);o.byIndex=l,t.splice(l,0,{identifier:u,updater:g,references:1})}a.push(u)}return a}function r(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,r){var i=o(e=e||[],r=r||{});return function(e){e=e||[];for(var a=0;a<i.length;a++){var l=n(i[a]);t[l].references--}for(var s=o(e,r),d=0;d<i.length;d++){var c=n(i[d]);0===t[c].references&&(t[c].updater(),t.splice(c,1))}i=s}}},113:e=>{"use strict";e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},244:e=>{"use strict";e.exports=n},314:e=>{"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",o=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),o&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),o&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,o,r,i){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(o)for(var l=0;l<this.length;l++){var s=this[l][0];null!=s&&(a[s]=!0)}for(var d=0;d<e.length;d++){var c=[].concat(e[d]);o&&a[c[0]]||(void 0!==i&&(void 0===c[5]||(c[1]="@layer".concat(c[5].length>0?" ".concat(c[5]):""," {").concat(c[1],"}")),c[5]=i),n&&(c[2]?(c[1]="@media ".concat(c[2]," {").concat(c[1],"}"),c[2]=n):c[2]=n),r&&(c[4]?(c[1]="@supports (".concat(c[4],") {").concat(c[1],"}"),c[4]=r):c[4]="".concat(r)),t.push(c))}},t}},400:(e,t,n)=>{"use strict";n.d(t,{A:()=>l});var o=n(601),r=n.n(o),i=n(314),a=n.n(i)()(r());a.push([e.id,'.parking-lot-widget{padding:16px;font-family:"Avenir Next","Helvetica Neue",Arial,sans-serif}.widget-header{margin-bottom:16px}.widget-header h3{margin:0;font-size:18px;font-weight:600;color:#323232}.widget-content{min-height:100px}.parking-lot-list{display:flex;flex-direction:column;gap:12px}.parking-lot-item{background:white;border-radius:8px;padding:10px 12px;box-shadow:0 2px 8px rgba(0, 0, 0, 0.1);border:1px solid #e0e0e0}.parking-lot-content{display:flex;align-items:center;gap:12px;margin-bottom:2px}.utilization-dot{width:20px;height:20px;border-radius:50%;flex-shrink:0;border:2px solid white;box-shadow:0 1px 3px rgba(0, 0, 0, 0.2)}.parking-lot-name{font-size:16px;font-weight:700;color:#323232;line-height:1.3;display:flex;align-items:center}.utilization-text{font-size:14px;color:#666;font-weight:400;margin-left:32px}.no-data{text-align:center;color:#999;font-style:italic;padding:20px;background:#f8f8f8;border-radius:8px;border:1px dashed #ccc}.loading{text-align:center;color:#666;padding:20px;background:#f8f8f8;border-radius:8px;border:1px solid #e0e0e0}@media(max-width: 480px){.parking-lot-widget{padding:12px}.parking-lot-item{padding:10px}.parking-lot-name{font-size:14px}.utilization-text{font-size:12px}}.parking-lot-item:hover{box-shadow:0 4px 12px rgba(0, 0, 0, 0.15);transform:translateY(-1px);transition:all .2s ease}.parking-lot-widget.loading{opacity:.6;pointer-events:none}.parking-lot-widget.loading::after{content:"";position:absolute;top:50%;left:50%;width:20px;height:20px;margin:-10px 0 0 -10px;border:2px solid #f3f3f3;border-top:2px solid #3498db;border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}',""]);const l=a},540:e=>{"use strict";e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},601:e=>{"use strict";e.exports=function(e){return e[1]}},659:e=>{"use strict";var t={};e.exports=function(e,n){var o=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!o)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");o.appendChild(n)}},686:e=>{"use strict";e.exports=o},825:e=>{"use strict";e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var o="";n.supports&&(o+="@supports (".concat(n.supports,") {")),n.media&&(o+="@media ".concat(n.media," {"));var r=void 0!==n.layer;r&&(o+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),o+=n.css,r&&(o+="}"),n.media&&(o+="}"),n.supports&&(o+="}");var i=n.sourceMap;i&&"undefined"!=typeof btoa&&(o+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),t.styleTagTransform(o,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}}},t={};function r(n){var o=t[n];if(void 0!==o)return o.exports;var i=t[n]={id:n,exports:{}};return e[n](i,i.exports,r),i.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.p="",r.nc=void 0;var i={};return r.p=window.jimuConfig.baseUrl,(()=>{"use strict";r.r(i),r.d(i,{__set_webpack_public_path__:()=>N,default:()=>M});var e=r(244),t=r(686),n=r(72),o=r.n(n),a=r(825),l=r.n(a),s=r(659),d=r.n(s),c=r(56),u=r.n(c),p=r(540),f=r.n(p),g=r(113),h=r.n(g),m=r(400),v={};v.styleTagTransform=h(),v.setAttributes=u(),v.insert=d().bind(null,"head"),v.domAPI=l(),v.insertStyleElement=f();o()(m.A,v);m.A&&m.A.locals&&m.A.locals;const x="Please configure a data source in the widget settings";var y=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function a(e){try{s(o.next(e))}catch(e){i(e)}}function l(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,l)}s((o=o.apply(e,t||[])).next())}))};const b="http://www.w3.org/2000/svg",A=50,w=46,S=(e,t,n,o)=>{const r=Math.PI/180*o;return{x:e+n*Math.cos(r),y:t+n*Math.sin(r)}},C=(e,t,n,o,r)=>{const i=o+r,a=S(e,t,n,o),l=S(e,t,n,i),s=r>180?"1":"0";return["M",a.x.toFixed(2),a.y.toFixed(2),"A",n.toFixed(2),n.toFixed(2),"0",s,"1",l.x.toFixed(2),l.y.toFixed(2)].join(" ")},k=(e,t,n,o,r)=>{const i=S(e,t,n,o),a=S(e,t,n,o+r),l=r>180?"1":"0";return["M",e.toFixed(2),t.toFixed(2),"L",i.x.toFixed(2),i.y.toFixed(2),"A",n.toFixed(2),n.toFixed(2),"0",l,"1",a.x.toFixed(2),a.y.toFixed(2),"Z"].join(" ")},E=(...e)=>{console.log("[ParkingLotWidget]",...e),console.warn("[ParkingLotWidget DEBUG]",...e)},M=n=>{const{config:o,id:r,useDataSources:i,useMapWidgetIds:a}=n;e.React.useEffect((()=>{}),[r,i,a]);const[l,s]=e.React.useState(null),[d,c]=e.React.useState([]),[u,p]=e.React.useState(null),[f,g]=e.React.useState(null),[h,m]=e.React.useState(null),[v,S]=e.React.useState(!1),M=e.React.useRef(null),N=e.React.useRef([]),F=e.React.useRef(null),I=e.React.useRef(!1);e.React.useEffect((()=>{if(l&&d.length>0){const e=()=>{const e=l.view.zoom,t=Math.max(.3,Math.min(1,(e-10)/8));d.forEach((e=>{try{const n=l.view.toScreen(e.geometry);if(e.element){e.element.style.transform=`scale(${t})`,e.element.style.transformOrigin="20px bottom";const o=e.element.offsetHeight||60;e.element.style.left=n.x-20+"px",e.element.style.top=n.y-o-8+"px"}}catch(e){}}))},t=[l.view.watch("extent",e),l.view.watch("center",e),l.view.watch("zoom",e)];return e(),()=>{t.forEach((e=>{e&&"function"==typeof e.remove&&e.remove()}))}}}),[l,d]),e.React.useEffect((()=>()=>{d.forEach((e=>{e.element&&e.element.parentNode&&e.element.parentNode.removeChild(e.element)}))}),[d]),e.React.useEffect((()=>{document.querySelectorAll(".parking-lot-map-label").forEach((e=>{e.parentNode&&e.parentNode.removeChild(e)})),c([]),g(null)}),[o.parkingLotField,o.utilizationField,o.showUtilizationText,o.allowNegatives,o.fullThreshold]),e.React.useEffect((()=>{if(!i||0===i.length)return void g(null);const e=i[0].dataSourceId;if(E("DataSource ID check:",{newId:e,currentId:f,changed:null!==f&&e!==f}),null!==f&&e!==f){E("DataSource ID changed, clearing labels and resetting tracking");document.querySelectorAll(".parking-lot-map-label").forEach((e=>{e.parentNode&&e.parentNode.removeChild(e)})),c([]),F.current=null,I.current=!1}f!==e&&(E("Setting currentDataSourceId to:",e),g(e))}),[i,f]),e.React.useEffect((()=>{var e,t,n;if(!M.current||!(null===(e=null==l?void 0:l.view)||void 0===e?void 0:e.ready)||!f)return;const r=M.current,a=null===(t=null==i?void 0:i[0])||void 0===t?void 0:t.dataSourceId;if(!a||f!==a||"LOADED"!==r.getStatus())return;let s="";const d=e=>{try{return e&&0!==e.length?e.map((e=>{var t,n,r,i,a,l,s,d,c;try{let u,p,f,g;return"function"==typeof(null==e?void 0:e.getId)?(u=e.getId()||"unknown",p=(null===(n=(t=e).getData)||void 0===n?void 0:n.call(t))||{}):(null==e?void 0:e.feature)?(u=(null===(i=null===(r=e.feature)||void 0===r?void 0:r.attributes)||void 0===i?void 0:i.OBJECTID)||(null===(l=null===(a=e.feature)||void 0===a?void 0:a.attributes)||void 0===l?void 0:l.FID)||"unknown",p=(null===(s=e.feature)||void 0===s?void 0:s.attributes)||{}):(null==e?void 0:e.attributes)?(u=(null===(d=e.attributes)||void 0===d?void 0:d.OBJECTID)||(null===(c=e.attributes)||void 0===c?void 0:c.FID)||"unknown",p=e.attributes||{}):(u="unknown",p={}),f=String(p[o.parkingLotField]||""),g=Number(p[o.utilizationField]||0),`${u}:${f}:${g}`}catch(t){return E("Error processing record in hash:",t,e),""}})).filter(Boolean).sort().join("|"):"empty"}catch(e){return E("Error creating data hash:",e),"error"}},c=(null===(n=null==r?void 0:r.getAutoRefreshInterval)||void 0===n?void 0:n.call(r))||0,u=c>0;E("DataSource auto-refresh:",{enabled:u,interval:c>0?`${c}ms`:"disabled"});y(void 0,void 0,void 0,(function*(){var e;try{const t={returnGeometry:!0,outFields:["*"],pageSize:1e3},n=yield null===(e=null==r?void 0:r.query)||void 0===e?void 0:e.call(r,t),o=(null==n?void 0:n.records)||[];o&&o.length>0&&(s=d(o),E("\u{1f680} Real-time update watcher started",{dataSourceId:a,initialRecordCount:o.length,checkInterval:"30000ms"}))}catch(e){E("Error initializing data watcher:",e)}}));const p=setInterval((()=>{try{if("LOADED"!==r.getStatus())return void E("DataSource status:",r.getStatus());const e={returnGeometry:!0,outFields:["*"],pageSize:1e3};y(void 0,void 0,void 0,(function*(){var t;try{const n=yield null===(t=null==r?void 0:r.query)||void 0===t?void 0:t.call(r,e),o=(null==n?void 0:n.records)||[];if(!o||0===o.length)return void E("No records returned from query");const i=d(o);E("Checking for data updates...",{recordCount:(null==o?void 0:o.length)||0,hasChanged:i!==s,autoRefreshEnabled:u,lastHashLength:s.length,currentHashLength:i.length,lastHashPreview:s.substring(0,50),currentHashPreview:i.substring(0,50)}),i!==s&&""!==s&&"error"!==i?(E("\u2705 DATA CHANGED DETECTED! Updating labels...",{recordCount:(null==o?void 0:o.length)||0}),E("Data changed, triggering label update (will update in place)"),S(!0),I.current=!1,s=i):""===s?(E("Initial data hash stored",{hashLength:i.length,recordCount:o.length}),s=i):E("No data changes detected",{hashMatch:i===s})}catch(e){E("Error querying for data updates:",e)}}))}catch(e){E("Error in checkForDataUpdates:",e)}}),3e4);return()=>{clearInterval(p)}}),[M.current,l,f,o.parkingLotField,o.utilizationField,i]);const D=e=>{var t;const n=Math.max(0,Math.min(100,null!==(t=o.fullThreshold)&&void 0!==t?t:95));let r=100-e;if(!o.allowNegatives&&r<0&&(r=0),e>=n||r<=Math.max(0,100-n))return"Full";const i=Math.max(0,Math.min(100,r));return`${Math.round(i)}% Available`},z=(e,t)=>{const n=100-Math.max(0,Math.min(100,e)),o=Math.min(n/100*360,359.999),r=document.createElement("div");r.style.cssText="\n      width: 44px;\n      height: 44px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      flex-shrink: 0;\n      pointer-events: none;\n    ",r.setAttribute("aria-hidden","true");const i=document.createElementNS(b,"svg");i.setAttribute("width","44"),i.setAttribute("height","44"),i.setAttribute("viewBox","0 0 100 100"),i.style.display="block",i.style.flexShrink="0",i.style.pointerEvents="none",i.setAttribute("role","presentation"),i.setAttribute("focusable","false");const a=document.createElementNS(b,"circle");if(a.setAttribute("cx",A.toFixed(2)),a.setAttribute("cy",A.toFixed(2)),a.setAttribute("r",w.toFixed(2)),a.setAttribute("fill","rgba(224,224,224,0.25)"),a.setAttribute("stroke","none"),i.appendChild(a),n>0)if(n>=99.5){const e=document.createElementNS(b,"circle");e.setAttribute("cx",A.toFixed(2)),e.setAttribute("cy",A.toFixed(2)),e.setAttribute("r",(w-3).toFixed(2)),e.setAttribute("fill",t),e.setAttribute("stroke","none"),i.appendChild(e)}else{const e=document.createElementNS(b,"path");e.setAttribute("d",k(A,A,w-3,-90,o)),e.setAttribute("fill",t),e.setAttribute("stroke","none"),i.appendChild(e);const n=document.createElementNS(b,"path");n.setAttribute("d",C(A,A,w-3,-90,o)),n.setAttribute("fill","none"),n.setAttribute("stroke",t),n.setAttribute("stroke-width","3.5"),i.appendChild(n)}const l=document.createElementNS(b,"circle");return l.setAttribute("cx",A.toFixed(2)),l.setAttribute("cy",A.toFixed(2)),l.setAttribute("r",(w-1.5).toFixed(2)),l.setAttribute("fill","none"),l.setAttribute("stroke","#333333"),l.setAttribute("stroke-width","3"),i.appendChild(l),r.appendChild(i),r};return(0,e.jsx)("div",{className:"parking-lot-widget jimu-widget","data-widget-id":r,style:{width:"100%",height:"100%",overflow:"hidden",position:"relative"}},a&&a.length>0&&(0,e.jsx)(t.JimuMapViewComponent,{useMapWidgetId:a[0],onActiveViewChange:e=>{if(e){s(e);let t=document.querySelector(`[data-widget-id="${null==a?void 0:a[0]}"] .map-root`);if(t||(t=document.querySelector(`[data-widget-id="${null==a?void 0:a[0]}"] .esri-view`),t||(t=document.querySelector(`[data-widget-id="${null==a?void 0:a[0]}"] .esri-view-root`)),t||(t=document.querySelector(`[data-widget-id="${null==a?void 0:a[0]}"]`))),t)p(t);else{const e=document.querySelector(".esri-view-root");e&&p(e)}}}}),i&&i.length>0&&u?(0,e.jsx)(e.DataSourceComponent,{useDataSource:i[0],widgetId:r,query:{},queryAll:!0,onDataSourceInfoChange:(e,t)=>{if(e&&void 0!==e.sourceVersion){if(t&&e.sourceVersion!==t.sourceVersion){document.querySelectorAll(".parking-lot-map-label").forEach((e=>{e.parentNode&&e.parentNode.removeChild(e)})),c([]),m(e.sourceVersion),S(!0)}else null===h&&m(e.sourceVersion)}},onQueryRequired:(e,t)=>{var n;if(e&&t){const o=null===(n=i[0])||void 0===n?void 0:n.dataSourceId;if(o&&e[o]&&t[o]){const n=e[o].sourceVersion;n!==t[o].sourceVersion&&(S(!0),m(n))}}}},(t=>{var n,r,a;if(E("DataSourceComponent render function called",{hasDataSource:!!t,status:null===(n=null==t?void 0:t.getStatus)||void 0===n?void 0:n.call(t),dataSourceId:null===(r=null==i?void 0:i[0])||void 0===r?void 0:r.dataSourceId}),!t)return M.current=null,E("\u26a0\ufe0f No DataSource available"),null;if(M.current=t,E("DataSource stored in ref",{id:t.id,type:t.type,status:t.getStatus()}),"LOADED"===t.getStatus()){const n=i[0].dataSourceId,r=document.querySelectorAll(".parking-lot-map-label").length,s=F.current===n&&r>0,p=I.current,g=0===r,h=v,m=f===n,x=null===(a=null==l?void 0:l.view)||void 0===a?void 0:a.ready,M=!p&&(g||h)&&m&&x;if(E("Label update check:",{needsUpdate:M,hasNoLabels:g,shouldUpdate:h,dsMatches:m,mapReady:x,labelsInDOM:r,labelsInState:d.length,alreadyCreated:s,isCreating:p,createdForDS:F.current,currentDsId:f,targetDsId:n}),M){I.current=!0,E("\u{1f504} Creating/updating labels...",{reason:v?"Data update detected":"Initial load",dataSourceId:n,hasNoLabels:g,shouldUpdate:h});const r={returnGeometry:!0,outFields:["*"],pageSize:1e3};y(void 0,void 0,void 0,(function*(){var i;try{const a=yield null===(i=null==t?void 0:t.query)||void 0===i?void 0:i.call(t,r),s=(null==a?void 0:a.records)||[];if(s&&s.length>0){const t=s.map((e=>(null==e?void 0:e.feature)?e.feature:"function"==typeof(null==e?void 0:e.getJSAPIGraphic)?null:"function"==typeof(null==e?void 0:e.getJSAPIGeometry)?{geometry:e.getJSAPIGeometry(),attributes:e.getData()}:null)).filter((e=>e));if(t.length>0)if(h&&!g){E("Updating existing labels in place...");try{yield(e=>y(void 0,void 0,void 0,(function*(){if(E("updateExistingLabels called",{hasMapContainer:!!u,hasJimuMapView:!!l,recordCount:(null==e?void 0:e.length)||0}),!u||!l)return void E("\u274c Cannot update labels - missing mapContainer or jimuMapView");const t=u.querySelectorAll(".parking-lot-map-label"),n=new Map,r=new Set;t.forEach((e=>{const t=e.getAttribute("data-parking-lot-id");t&&n.set(t,e)})),E("Updating existing labels:",{existingLabelsCount:n.size,recordsCount:e.length});for(const t of e){let e,i=null;if("function"==typeof t.getData){e=t.getData();try{if("function"==typeof t.getJSAPIGeometry)i=t.getJSAPIGeometry();else if("function"==typeof t.getGeometry){const e=t.getGeometry();e&&(i=e)}}catch(e){continue}}else t.attributes&&t.geometry?(e=t.attributes,i=t.geometry):(e=t.data||t.attributes||t,i=t.geometry||t.geom||null);const a=null==e?void 0:e[o.parkingLotField],s=null==e?void 0:e[o.utilizationField];if(!i||!a)continue;const d=String(a);r.add(d);const c=n.get(d);if(!c)continue;const u=Number(s),p=Number.isFinite(u)?u:0,f="#F44336",g=D(p),h=o.showUtilizationText?g:"";let m=100-p;!o.allowNegatives&&m<0&&(m=0);const v=Math.max(0,Math.min(100,m));try{const e=l.view.toScreen(i),t=e.x-50+"px",n=e.y-30+"px";c.style.left!==t&&(c.style.left=t),c.style.top!==n&&(c.style.top=n)}catch(e){}c.setAttribute("aria-label",`${a}: ${g}`);const x=Array.from(c.children),y=x[0],S=x[1];if(y){const e=y.querySelector("svg");if(e){const t=100-Math.max(0,Math.min(100,v)),n=Math.min(t/100*360,359.999),o=Array.from(e.children);for(let t=o.length-2;t>=1;t--)e.removeChild(o[t]);if(t>0)if(t>=99.5){const t=document.createElementNS(b,"circle");t.setAttribute("cx",A.toFixed(2)),t.setAttribute("cy",A.toFixed(2)),t.setAttribute("r",(w-3).toFixed(2)),t.setAttribute("fill",f),t.setAttribute("stroke","none"),e.insertBefore(t,e.lastChild)}else{const t=document.createElementNS(b,"path");t.setAttribute("d",k(A,A,w-3,-90,n)),t.setAttribute("fill",f),t.setAttribute("stroke","none"),e.insertBefore(t,e.lastChild);const o=document.createElementNS(b,"path");o.setAttribute("d",C(A,A,w-3,-90,n)),o.setAttribute("fill","none"),o.setAttribute("stroke",f),o.setAttribute("stroke-width","3.5"),e.insertBefore(o,e.lastChild)}}}if(S){const e=Array.from(S.children);let t=o.showUtilizationText?0:-1,n=o.showUtilizationText?1:0;if(o.showUtilizationText&&t>=0&&e[t]){const n=e[t];n.textContent!==h&&(n.textContent=h)}if(e[n]){const t=e[n];t.textContent!==a&&(t.textContent=a)}}}n.forEach(((e,t)=>{r.has(t)||(E("Removing label for parking lot that no longer exists:",t),e.parentNode&&e.parentNode.removeChild(e))})),E("Finished updating existing labels:",{processed:r.size,removed:n.size-r.size})})))(t),S(!1),I.current=!1,E("\u2705 Labels updated successfully")}catch(e){E("Error updating labels:",e),S(!1),I.current=!1}}else E("Creating",t.length,"new labels on map",{mapContainer:!!u,mapContainerElement:null==u?void 0:u.tagName,jimuMapView:!!l}),setTimeout((()=>y(void 0,void 0,void 0,(function*(){try{yield(t=>y(void 0,void 0,void 0,(function*(){var n,r,i,a,s,d,p;if(E("createCustomLabels called",{hasMapContainer:!!u,hasJimuMapView:!!l,recordCount:(null==t?void 0:t.length)||0}),!u||!l)return void E("\u274c Cannot create labels - missing mapContainer or jimuMapView",{mapContainer:!!u,jimuMapView:!!l});let f=null,g=null;try{const t=yield(0,e.loadArcGISJSAPIModules)(["esri/geometry/projection","esri/geometry/Point","esri/geometry/SpatialReference"]);f=t[0],g=t[1],t[2],yield f.load()}catch(e){}const h=new Set,m=[],v=new Map,x=u?u.querySelectorAll(".parking-lot-map-label"):document.querySelectorAll(".parking-lot-map-label");E("Building existing labels map:",{totalFound:x.length,mapContainer:!!u}),x.forEach((e=>{const t=e.getAttribute("data-parking-lot-id");t&&(v.set(t,e),E("Found existing label:",t))})),E("Existing labels map built:",{mapSize:v.size,lotIds:Array.from(v.keys())});let y=0,S={};t.length>0&&E("First record structure:",{record:t[0],keys:Object.keys(t[0]||{}),hasGetData:"function"==typeof(null===(n=t[0])||void 0===n?void 0:n.getData),hasGetJSAPIGeometry:"function"==typeof(null===(r=t[0])||void 0===r?void 0:r.getJSAPIGeometry),hasGetGeometry:"function"==typeof(null===(i=t[0])||void 0===i?void 0:i.getGeometry),hasAttributes:!!(null===(a=t[0])||void 0===a?void 0:a.attributes),hasGeometry:!!(null===(s=t[0])||void 0===s?void 0:s.geometry),constructorName:null===(p=null===(d=t[0])||void 0===d?void 0:d.constructor)||void 0===p?void 0:p.name});for(const e of t){let t,n=null;if("function"==typeof e.getData){t=e.getData();try{if("function"==typeof e.getJSAPIGeometry)n=e.getJSAPIGeometry();else if("function"==typeof e.getGeometry){const t=e.getGeometry();t&&(n=t)}}catch(e){E("Error getting geometry from DataRecord:",e)}}else e.attributes&&e.geometry?(t=e.attributes,n=e.geometry):(E("Unknown record structure, trying direct access:",{recordKeys:Object.keys(e||{}),recordType:typeof e,recordValue:e}),t=e.data||e.attributes||e,n=e.geometry||e.geom||null);const r=null==t?void 0:t[o.parkingLotField],i=null==t?void 0:t[o.utilizationField];if(!n){y++,S.noGeometry=(S.noGeometry||0)+1,E("Skipping record - no geometry",{isDataRecord:"function"==typeof e.getData,hasGetJSAPIGeometry:"function"==typeof e.getJSAPIGeometry,hasGetGeometry:"function"==typeof e.getGeometry,hasGeometryProperty:!!e.geometry,hasAttributes:!!e.attributes,recordType:typeof e,recordKeys:Object.keys(e||{})});continue}if(!r){y++,S.noName=(S.noName||0)+1,E("Skipping record - no parking lot name",t);continue}E("Processing record:",r,{hasGeometry:!!n,hasName:!!r,utilization:i});const a=Number(i),s=Number.isFinite(a)?a:0,d="#F44336",c=D(s),p=o.showUtilizationText?c:"";let g=100-s;!o.allowNegatives&&g<0&&(g=0);const x=Math.max(0,Math.min(100,g)),M=String(r);h.add(M);try{const e=l.view.spatialReference,t=n.spatialReference;if(f&&t&&e&&t.wkid!==e.wkid){const t=f.project(n,e);t&&(n=t)}}catch(e){}let N;try{N=l.view.toScreen(n)}catch(e){y++,S.coordError=(S.coordError||0)+1,E("\u274c Error converting to screen coordinates:",e,r);continue}let F=v.get(M);const I=!F;if(E("Checking for existing label:",{lotId:M,found:!!F,isNewLabel:I,mapSize:v.size}),F){E("Updating existing label in place:",r,{utilization:i,availabilityText:p});const e=N.x-50+"px",a=N.y-30+"px";F.style.left!==e&&(F.style.left=e),F.style.top!==a&&(F.style.top=a),F.setAttribute("aria-label",`${r}: ${c}`);const l=Array.from(F.children),s=l[0],u=l[1];if(s){const e=s.querySelector("svg");if(e){const t=100-Math.max(0,Math.min(100,x)),n=Math.min(t/100*360,359.999),o=Array.from(e.children);for(let t=o.length-2;t>=1;t--)e.removeChild(o[t]);if(t>0)if(t>=99.5){const t=document.createElementNS(b,"circle");t.setAttribute("cx",A.toFixed(2)),t.setAttribute("cy",A.toFixed(2)),t.setAttribute("r",(w-3).toFixed(2)),t.setAttribute("fill",d),t.setAttribute("stroke","none"),e.insertBefore(t,e.lastChild)}else{const t=document.createElementNS(b,"path");t.setAttribute("d",k(A,A,w-3,-90,n)),t.setAttribute("fill",d),t.setAttribute("stroke","none"),e.insertBefore(t,e.lastChild);const o=document.createElementNS(b,"path");o.setAttribute("d",C(A,A,w-3,-90,n)),o.setAttribute("fill","none"),o.setAttribute("stroke",d),o.setAttribute("stroke-width","3.5"),e.insertBefore(o,e.lastChild)}}}if(u){const e=Array.from(u.children);let t=o.showUtilizationText?0:-1,n=o.showUtilizationText?1:0;if(o.showUtilizationText&&t>=0&&e[t]){const n=e[t];n.textContent!==p&&(n.textContent=p)}if(e[n]){const t=e[n];t.textContent!==r&&(t.textContent=r)}}m.push({element:F,geometry:n,data:t});continue}F=document.createElement("div"),F.className="parking-lot-map-label",F.setAttribute("role","img"),F.setAttribute("aria-label",`${r}: ${c}`),F.setAttribute("tabindex","-1"),F.setAttribute("data-parking-lot-id",M),F.style.cssText=`\n        position: absolute;\n        left: ${N.x-50}px;\n        top: ${N.y-30}px;\n        background: white;\n        border-radius: 12px;\n        padding: 8px 8px;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n        border: 1px solid #d0d0d0;\n        font-family: 'Avenir Next', 'Helvetica Neue', Arial, sans-serif;\n        z-index: 1000;\n        pointer-events: none;\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        min-width: 150px;\n      `;const T=document.createElement("div");T.style.cssText="\n        position: absolute;\n        bottom: -8px;\n        left: 20px;\n        width: 0;\n        height: 0;\n        border-left: 8px solid transparent;\n        border-right: 8px solid transparent;\n        border-top: 8px solid white;\n        z-index: 1001;\n      ";const G=document.createElement("div");G.style.cssText="\n        position: absolute;\n        bottom: -9px;\n        left: 20px;\n        width: 0;\n        height: 0;\n        border-left: 9px solid transparent;\n        border-right: 9px solid transparent;\n        border-top: 9px solid #d0d0d0;\n        z-index: 1000;\n      ";const R=z(x,d),L=document.createElement("div");if(L.style.cssText="\n        display: flex;\n        flex-direction: column;\n        gap: 1px;\n      ",o.showUtilizationText){const e=document.createElement("div");e.textContent=p,e.style.cssText="\n          font-size: 16px;\n          color: #000000;\n          line-height: 1.2;\n          font-weight: 900;\n        ",L.appendChild(e)}const P=document.createElement("div");P.textContent=r,P.style.cssText="\n        font-size: 13px;\n        font-weight: 700;\n        color: #000000;\n        line-height: 1.2;\n      ",L.appendChild(P),F.appendChild(R),F.appendChild(L),F.appendChild(G),F.appendChild(T);const j=F.childNodes.length;if(E("Label content added:",{parkingLotName:r,isNewLabel:I,childCount:j,hasGauge:!!R,hasText:!!L,utilizationText:p}),I)try{u.appendChild(F),E("Label added to DOM:",r)}catch(e){E("\u274c Error adding label to DOM:",e,r);continue}else E("Label updated in place:",r,{finalChildCount:F.childNodes.length,textContent:L.textContent});m.push({element:F,geometry:n,data:t})}v.forEach(((e,t)=>{h.has(t)||(E("Removing label for parking lot that no longer exists:",t),e.parentNode&&e.parentNode.removeChild(e))}));const M=document.querySelectorAll(".parking-lot-map-label").length;E("Finished updating labels:",{totalProcessed:m.length,newLabels:m.filter((e=>!v.has(e.element.getAttribute("data-parking-lot-id")||""))).length,updatedLabels:m.filter((e=>v.has(e.element.getAttribute("data-parking-lot-id")||""))).length,skipped:y,skippedReasons:S,mapContainerExists:!!u,labelsInDOM:M,mapContainerType:u?u.tagName:"null",recordCount:t.length}),N.current=m,c(m)})))(t);const r=document.querySelectorAll(".parking-lot-map-label").length;E("After createCustomLabels:",{labelsInDOM:r,expected:t.length}),r>0?(F.current=n,E("\u2705 Labels created successfully for DS:",n,"Count:",r)):(E("\u274c Labels not in DOM after creation!",{mapContainer:!!u,mapContainerParent:(null==u?void 0:u.parentNode)?u.parentNode.tagName:"null"}),I.current=!1)}catch(e){E("Error creating labels:",e),I.current=!1}}))),500);else E("\u26a0\ufe0f No features extracted from records"),I.current=!1}else E("\u26a0\ufe0f No records returned from query"),I.current=!1}catch(e){E("\u274c Error querying DataSource:",e),I.current=!1}}))}}return null})):null,a&&0!==a.length?i&&0!==i.length?null:(0,e.jsx)("div",{className:"no-data"},(0,e.jsx)(e.FormattedMessage,{id:"configureDataSource",defaultMessage:x})):(0,e.jsx)("div",{className:"no-data"},(0,e.jsx)(e.FormattedMessage,{id:"selectMap",defaultMessage:"Please select a map widget in the settings"})))};function N(e){r.p=e}})(),i})())}}}));